<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demande de Soumission - Jardins de Florence</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            min-height: 100vh;
            padding: 20px;
            color: #334155;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 24px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .header {
            background: linear-gradient(135deg, #064e3b 0%, #047857 25%, #059669 75%, #10b981 100%);
            color: white;
            padding: 50px 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="75" cy="75" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="50" cy="10" r="0.5" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
            z-index: 1;
        }

        .header-content {
            position: relative;
            z-index: 2;
        }

        .header h1 {
            font-size: 3em;
            margin-bottom: 15px;
            font-weight: 700;
            letter-spacing: -0.02em;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .header .icon {
            font-size: 3.5em;
            margin-bottom: 15px;
            display: block;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.2));
        }

        .header p {
            font-size: 1.3em;
            opacity: 0.95;
            font-weight: 300;
            letter-spacing: 0.01em;
        }

        .form-container {
            padding: 50px;
        }

        .form-section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 1.4em;
            font-weight: 600;
            color: #064e3b;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section-title .icon {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #10b981, #059669);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #1f2937;
            font-size: 1.1em;
        }

        .required {
            color: #dc2626;
            margin-left: 4px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1em;
            transition: all 0.3s ease;
            font-family: inherit;
            background: #fafafa;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
            background: white;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 120px;
        }

        .services-section {
            background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
            padding: 40px;
            border-radius: 20px;
            margin: 40px 0;
            border: 1px solid #bbf7d0;
            position: relative;
        }

        .services-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="dots" width="20" height="20" patternUnits="userSpaceOnUse"><circle cx="10" cy="10" r="1" fill="rgba(16,185,129,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23dots)"/></svg>');
            border-radius: 20px;
            opacity: 0.5;
        }

        .services-section > * {
            position: relative;
            z-index: 1;
        }

        .services-section h3 {
            color: #064e3b;
            margin-bottom: 30px;
            font-size: 1.5em;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .service-selector {
            display: grid;
            grid-template-columns: 2fr 1fr auto;
            gap: 16px;
            align-items: end;
            margin-bottom: 25px;
            padding: 24px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .service-dropdown select {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-color: #10b981;
        }

        .quantity-input input {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border-color: #10b981;
            text-align: center;
        }

        .add-service-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 16px 24px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            height: fit-content;
        }

        .add-service-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(16, 185, 129, 0.3);
        }

        .add-service-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .selected-services {
            margin-top: 30px;
        }

        .selected-services h4 {
            color: #064e3b;
            margin-bottom: 20px;
            font-size: 1.2em;
            font-weight: 600;
        }

        .service-item {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 12px;
            border: 2px solid #bbf7d0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .service-item:hover {
            border-color: #10b981;
            box-shadow: 0 4px 8px rgba(16, 185, 129, 0.1);
        }

        .service-info {
            flex-grow: 1;
        }

        .service-name {
            font-weight: 600;
            color: #064e3b;
            margin-bottom: 4px;
        }

        .service-details {
            color: #6b7280;
            font-size: 0.9em;
        }

        .service-price {
            color: #059669;
            font-weight: 600;
            font-size: 1.1em;
            margin: 0 20px;
        }

        .remove-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .remove-btn:hover {
            background: #dc2626;
            transform: scale(1.05);
        }

        .empty-services {
            text-align: center;
            color: #6b7280;
            font-style: italic;
            padding: 30px;
            border: 2px dashed #d1d5db;
            border-radius: 12px;
        }

        .submit-btn, .test-btn {
            background: linear-gradient(135deg, #064e3b 0%, #047857 25%, #059669 75%, #10b981 100%);
            color: white;
            padding: 18px 32px;
            border: none;
            border-radius: 16px;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 30px;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 8px 16px rgba(16, 185, 129, 0.3);
        }

        .submit-btn::before, .test-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .submit-btn:hover::before, .test-btn:hover::before {
            left: 100%;
        }

        .submit-btn:hover, .test-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 24px rgba(16, 185, 129, 0.4);
        }

        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .test-buttons {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
        }

        .test-btn {
            width: 48%;
            margin-top: 0;
            padding: 12px 20px;
            font-size: 0.9em;
        }

        .test-btn.supabase {
            background: linear-gradient(135deg, #dc2626, #ef4444);
        }

        .test-btn.webhook {
            background: linear-gradient(135deg, #d97706, #f59e0b);
        }

        .success-message, .error-message {
            display: none;
            padding: 30px;
            border-radius: 16px;
            margin-top: 30px;
            text-align: center;
            font-weight: 500;
        }

        .success-message {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            color: #064e3b;
            border: 2px solid #bbf7d0;
        }

        .error-message {
            background: linear-gradient(135deg, #fef2f2, #fee2e2);
            color: #991b1b;
            border: 2px solid #fca5a5;
        }

        .footer {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            padding: 30px;
            text-align: center;
            color: #64748b;
            font-size: 0.9em;
            border-top: 1px solid #e2e8f0;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 20px;
            }
            
            .header {
                padding: 40px 30px;
            }
            
            .form-container {
                padding: 40px 30px;
            }
            
            .header h1 {
                font-size: 2.2em;
            }

            .service-selector {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .test-buttons {
                flex-direction: column;
            }

            .test-btn {
                width: 100%;
            }

            .service-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .service-price {
                margin: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <span class="icon">🌿</span>
                <h1>Jardins de Florence</h1>
                <p>Demande de soumission personnalisée</p>
            </div>
        </div>

        <div class="form-container">
            <form id="quoteForm">
                <div class="form-section">
                    <div class="section-title">
                        <span class="icon">👤</span>
                        Informations client
                    </div>

                    <div class="form-group">
                        <label for="nom">Nom complet <span class="required">*</span></label>
                        <input type="text" id="nom" name="nom" required placeholder="Votre nom complet">
                    </div>

                    <div class="form-group">
                        <label for="email">Adresse courriel <span class="required">*</span></label>
                        <input type="email" id="email" name="email" required placeholder="votre@email.com">
                    </div>

                    <div class="form-group">
                        <label for="telephone">Téléphone</label>
                        <input type="tel" id="telephone" name="telephone" placeholder="(514) 555-1234">
                    </div>

                    <div class="form-group">
                        <label for="adresse">Adresse du projet</label>
                        <textarea id="adresse" name="adresse" placeholder="Adresse complète où les services seront réalisés"></textarea>
                    </div>
                </div>

                <div class="services-section">
                    <h3>
                        <span class="icon">🛠️</span>
                        Services demandés <span class="required">*</span>
                    </h3>

                    <!-- Service Selector -->
                    <div class="service-selector">
                        <div class="service-dropdown">
                            <label for="serviceSelect">Choisir un service</label>
                            <select id="serviceSelect">
                                <option value="">Sélectionnez un service...</option>
                            </select>
                        </div>
                        <div class="quantity-input">
                            <label for="quantityInput">Quantité</label>
                            <input type="number" id="quantityInput" min="0.1" step="0.1" placeholder="0">
                        </div>
                        <button type="button" class="add-service-btn" id="addServiceBtn" disabled>
                            ➕ Ajouter
                        </button>
                    </div>

                    <!-- Selected Services List -->
                    <div class="selected-services">
                        <h4>Services sélectionnés:</h4>
                        <div id="selectedServicesList">
                            <div class="empty-services">
                                Aucun service sélectionné
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="section-title">
                        <span class="icon">📝</span>
                        Informations additionnelles
                    </div>

                    <div class="form-group">
                        <label for="notes">Notes et demandes spéciales</label>
                        <textarea id="notes" name="notes" placeholder="Informations supplémentaires, contraintes particulières, demandes spéciales..."></textarea>
                    </div>
                </div>

                <!-- Test Buttons -->
                <div class="test-buttons">
                    <button type="button" class="test-btn supabase" onclick="testSupabaseConnection()">
                        🔍 Test Supabase
                    </button>
                    <button type="button" class="test-btn webhook" onclick="testN8nWebhook()">
                        🚀 Test n8n Webhook
                    </button>
                </div>

                <button type="submit" class="submit-btn" id="submitBtn">
                    📋 Envoyer ma demande de soumission
                </button>
            </form>

            <div class="success-message" id="successMessage">
                <h3>✅ Demande envoyée avec succès!</h3>
                <p>Votre demande de soumission a été transmise. Nous vous contacterons sous 24-48 heures avec votre devis personnalisé.</p>
            </div>

            <div class="error-message" id="errorMessage">
                <h3>❌ Erreur lors de l'envoi</h3>
                <p id="errorText">Une erreur s'est produite. Veuillez réessayer ou nous contacter directement.</p>
            </div>
        </div>

        <div class="footer">
            <p>© 2024 Jardins de Florence - Services d'aménagement paysager professionnel</p>
        </div>
    </div>

    <script>
      // Configuration
        const SUPABASE_URL = 'https://dfrjllweqpmdtqwofshd.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRmcmpsbHdlcXBtZHRxd29mc2hkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDkyMjk3MjQsImV4cCI6MjA2NDgwNTcyNH0.ggtZshpHhIO4gdNaSqW6vELxYBCrLlt2oeiydWL-tyc';
        const N8N_WEBHOOK_URL = 'https://primecallai.app.n8n.cloud/webhook-test/jardins-florence-quote';

        let availableServices = [];
        let selectedServices = [];

        // Services basés sur votre catalogue Supabase
        const servicesData = [
            { id: '1', nom: 'Ouverture de terrain (printemps)', categorie: 'Saisonnier', prix_unitaire: 275, unite: 'unité', description: 'Préparation du terrain pour la saison' },
            { id: '2', nom: 'Murets de soutènement (pierre ou bloc)', categorie: 'Structures', prix_unitaire: 220, unite: 'm²', description: 'Construction de murets' },
            { id: '3', nom: 'Taille de haies/arbustes', categorie: 'Entretien', prix_unitaire: 85, unite: 'heure', description: 'Taille professionnelle' },
            { id: '4', nom: 'Gazon synthétique (installé)', categorie: 'Pelouse', prix_unitaire: 85, unite: 'm²', description: 'Installation complète' },
            { id: '5', nom: 'Cuisine extérieure complète', categorie: 'Aménagements', prix_unitaire: 19000, unite: 'unité', description: 'Cuisine extérieure avec équipements' },
            { id: '6', nom: 'Gazonnement (rouleau de tourbe)', categorie: 'Pelouse', prix_unitaire: 7.5, unite: 'm²', description: 'Pose de tourbe' },
            { id: '7', nom: 'Enrochement paysager', categorie: 'Rocailles', prix_unitaire: 190, unite: 'm²', description: 'Aménagement rocheux' },
            { id: '8', nom: 'Déneigement sélectif paysager', categorie: 'Hiver', prix_unitaire: 355, unite: 'forfait mensuel', description: 'Service hivernal' },
            { id: '9', nom: 'Marches d\'escalier (pierre ou béton)', categorie: 'Structures', prix_unitaire: 250, unite: 'marche', description: 'Construction d\'escaliers' },
            { id: '10', nom: 'Désherbagе manuel et binage', categorie: 'Entretien', prix_unitaire: 60, unite: 'heure', description: 'Entretien manuel' },
            { id: '11', nom: 'Éclairage extérieur DEL (avec timer intelli)', categorie: 'Électricité', prix_unitaire: 250, unite: 'point', description: 'Installation d\'éclairage' },
            { id: '12', nom: 'Création de massifs de vivaces', categorie: 'Plantation', prix_unitaire: 60, unite: 'm²', description: 'Aménagement floral' },
            { id: '13', nom: 'Pavé uni (installation complète)', categorie: 'Revêtements', prix_unitaire: 110, unite: 'm²', description: 'Pavage complet' },
            { id: '14', nom: 'Bassins ou fontaines d\'eau', categorie: 'Eau', prix_unitaire: 7500, unite: 'unité', description: 'Installation aquatique' },
            { id: '15', nom: 'Fertilisation biologique (engrais organique)', categorie: 'Fertilisation', prix_unitaire: 65, unite: 'application', description: 'Traitement biologique' },
            { id: '16', nom: 'Terrasse en bois exotique', categorie: 'Terrasses', prix_unitaire: 220, unite: 'm²', description: 'Construction terrasse' },
            { id: '17', nom: 'Plantation d\'arbres (petit calibre)', categorie: 'Plantation', prix_unitaire: 180, unite: 'arbre', description: 'Plantation professionnelle' },
            { id: '18', nom: 'Entretien floral hebdomadaire', categorie: 'Entretien', prix_unitaire: 95, unite: 'visite', description: 'Entretien régulier' },
            { id: '19', nom: 'Pergola en bois (sur mesure)', categorie: 'Structures', prix_unitaire: 6500, unite: 'unité', description: 'Construction pergola' },
            { id: '20', nom: 'Fermeture de terrain (automne)', categorie: 'Saisonnier', prix_unitaire: 300, unite: 'unité', description: 'Préparation hivernale' },
            { id: '21', nom: 'Système d\'irrigation automatisé', categorie: 'Irrigation', prix_unitaire: 850, unite: 'zone', description: 'Arrosage automatique' },
            { id: '22', nom: 'Dallage en pierre naturelle', categorie: 'Revêtements', prix_unitaire: 180, unite: 'm²', description: 'Revêtement pierre' },
            { id: '23', nom: 'Foyer extérieur intégré (gaz ou bois)', categorie: 'Chauffage', prix_unitaire: 4500, unite: 'unité', description: 'Installation foyer' },
            { id: '24', nom: 'Terrasse en bois composite', categorie: 'Terrasses', prix_unitaire: 170, unite: 'm²', description: 'Terrasse composite' },
            { id: '25', nom: 'Protection hivernale des végétaux', categorie: 'Protection', prix_unitaire: 125, unite: 'unité', description: 'Protection hiver' }
        ];

        // Load services (try Supabase first, fallback to local data)
        async function loadServices() {
            console.log('🌱 Loading services...');
            
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/services_catalogue`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const supabaseServices = await response.json();
                    console.log('✅ Loaded from Supabase:', supabaseServices.length, 'services');
                    
                    if (supabaseServices.length > 0) {
                        availableServices = supabaseServices;
                        populateServiceDropdown();
                        return;
                    }
                }
            } catch (error) {
                console.log('⚠️ Supabase failed, using local data:', error.message);
            }
            
            // Fallback to local data
            console.log('🔄 Using local services data');
            availableServices = servicesData;
            populateServiceDropdown();
        }

        // Populate service dropdown
        function populateServiceDropdown() {
            const select = document.getElementById('serviceSelect');
            select.innerHTML = '<option value="">Sélectionnez un service...</option>';
            
            // Group by category
            const categories = {};
            availableServices.forEach(service => {
                const cat = service.categorie || 'Autres';
                if (!categories[cat]) {
                    categories[cat] = [];
                }
                categories[cat].push(service);
            });
            
            // Add options grouped by category
            Object.keys(categories).sort().forEach(category => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = category;
                
                categories[category].forEach(service => {
                    const option = document.createElement('option');
                    option.value = service.id;
                    option.textContent = `${service.nom} (${service.prix_unitaire}$ / ${service.unite})`;
                    optgroup.appendChild(option);
                });
                
                select.appendChild(optgroup);
            });
            
            console.log('✅ Dropdown populated with', availableServices.length, 'services');
        }

        // Handle service selection
        document.getElementById('serviceSelect').addEventListener('change', function() {
            const addBtn = document.getElementById('addServiceBtn');
            const quantityInput = document.getElementById('quantityInput');
            
            if (this.value) {
                addBtn.disabled = false;
                quantityInput.focus();
                
                // Update quantity input placeholder with unit
                const selectedService = availableServices.find(s => s.id === this.value);
                if (selectedService) {
                    quantityInput.placeholder = `Quantité en ${selectedService.unite}`;
                }
            } else {
                addBtn.disabled = true;
                quantityInput.placeholder = '0';
            }
        });

        // Add service to selection
        document.getElementById('addServiceBtn').addEventListener('click', function() {
            const serviceSelect = document.getElementById('serviceSelect');
            const quantityInput = document.getElementById('quantityInput');
            
            const serviceId = serviceSelect.value;
            const quantity = parseFloat(quantityInput.value);
            
            if (!serviceId || !quantity || quantity <= 0) {
                alert('Veuillez sélectionner un service et entrer une quantité valide.');
                return;
            }
            
            const service = availableServices.find(s => s.id === serviceId);
            if (!service) return;
            
            // Check if service already selected
            const existingIndex = selectedServices.findIndex(s => s.id === serviceId);
            if (existingIndex !== -1) {
                // Update quantity
                selectedServices[existingIndex].quantity += quantity;
                selectedServices[existingIndex].total = selectedServices[existingIndex].quantity * service.prix_unitaire;
            } else {
                // Add new service
                selectedServices.push({
                    id: serviceId,
                    nom: service.nom,
                    prix_unitaire: service.prix_unitaire,
                    unite: service.unite,
                    quantity: quantity,
                    total: quantity * service.prix_unitaire
                });
            }
            
            // Reset form
            serviceSelect.value = '';
            quantityInput.value = '';
            quantityInput.placeholder = '0';
            document.getElementById('addServiceBtn').disabled = true;
            
            // Update display
            updateSelectedServicesList();
        });

        // Update selected services list
        function updateSelectedServicesList() {
            const container = document.getElementById('selectedServicesList');
            
            if (selectedServices.length === 0) {
                container.innerHTML = '<div class="empty-services">Aucun service sélectionné</div>';
                return;
            }
            
            let html = '';
            selectedServices.forEach((service, index) => {
                html += `
                    <div class="service-item">
                        <div class="service-info">
                            <div class="service-name">${service.nom}</div>
                            <div class="service-details">${service.quantity} ${service.unite} × ${service.prix_unitaire}$</div>
                        </div>
                        <div class="service-price">${service.total.toFixed(2)}$</div>
                        <button type="button" class="remove-btn" onclick="removeService(${index})">✕</button>
                    </div>
                `;
            });
            
            // Add total
            const grandTotal = selectedServices.reduce((sum, service) => sum + service.total, 0);
            html += `
                <div class="service-item" style="border-color: #10b981; background: #f0fdf4; font-weight: 600;">
                    <div class="service-info">
                        <div class="service-name">Total (avant taxes)</div>
                        <div class="service-details">${selectedServices.length} service(s) sélectionné(s)</div>
                    </div>
                    <div class="service-price" style="font-size: 1.3em;">${grandTotal.toFixed(2)}$</div>
                    <div style="width: 40px;"></div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // Remove service from selection
        function removeService(index) {
            selectedServices.splice(index, 1);
            updateSelectedServicesList();
        }

        // Form submission
        document.getElementById('quoteForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (selectedServices.length === 0) {
                alert('Veuillez sélectionner au moins un service.');
                return;
            }
            
            const submitBtn = document.getElementById('submitBtn');
            const successMsg = document.getElementById('successMessage');
            const errorMsg = document.getElementById('errorMessage');
            
            // Hide previous messages
            successMsg.style.display = 'none';
            errorMsg.style.display = 'none';
            
            // Disable submit button
            submitBtn.disabled = true;
            submitBtn.textContent = '📤 Envoi en cours...';
            
            try {
                // Collect form data
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData);
                
                // Format services string for n8n
                const servicesString = selectedServices.map(service => 
                    `${service.nom},${service.quantity},${service.unite}`
                ).join(';');
                
                data.services = servicesString;
                
                console.log('📤 Sending data:', data);
                
                // Send to n8n webhook
                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || `HTTP Error ${response.status}`);
                }
                
                const result = await response.json();
                console.log('✅ Success:', result);
                
                // Show success message
                successMsg.style.display = 'block';
                document.getElementById('quoteForm').style.display = 'none';
                successMsg.scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                console.error('❌ Error:', error);
                document.getElementById('errorText').textContent = error.message;
                errorMsg.style.display = 'block';
                errorMsg.scrollIntoView({ behavior: 'smooth' });
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '📋 Envoyer ma demande de soumission';
            }
        });

        // Test functions
        async function testSupabaseConnection() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/services_catalogue`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                alert(`✅ Supabase Test: ${response.status}\n\nServices trouvés: ${data.length}\n\n${data.length === 0 ? 'Utilisation des données locales.' : 'Données Supabase chargées!'}`);
            } catch (error) {
                alert(`❌ Supabase Error: ${error.message}`);
            }
        }

        async function testN8nWebhook() {
            const testData = {
                nom: "Test Client",
                email: "test@example.com",
                services: "Test Service,1,unité"
            };
            
            try {
                const response = await fetch(N8N_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData)
                });
                
                const result = await response.json();
                alert(`✅ n8n Webhook Test: ${response.status}\n\nRéponse: ${JSON.stringify(result, null, 2)}`);
            } catch (error) {
                alert(`❌ n8n Webhook Error: ${error.message}`);
            }
        }

        // Load services when page loads
        document.addEventListener('DOMContentLoaded', loadServices);
    </script>
</body>
</html>
